name: "Release and Deploy"

run-name: "Release and deploy `${{ inputs.bump_type }}` to `${{ inputs.environment }}`"

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: "Version bump type"
        required: true
        type: choice
        default: patch
        options:
          - patch
          - minor
          - major
      environment:
        description: "Environment to deploy to"
        required: true
        type: choice
        default: prod
        options:
          - dev
          - prod
      run_legacy_cluster_tests:
        description: "Run cluster tests for frontend-legacy before deploying"
        required: true
        type: boolean
        default: true

jobs:
  release-and-deploy:
    name: Release and Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Trigger release workflow
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          gh workflow run release.yml \
            --repo ${{ github.repository }} \
            -f bump_type="${{ inputs.bump_type }}"

          echo "Release workflow triggered, waiting for completion ..."

      - name: Wait for release to complete
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          # Wait a moment for the workflow to be created
          sleep 5

          # Get the most recent release workflow run
          RUN_ID=$(gh run list \
            --repo ${{ github.repository }} \
            --workflow=release.yml \
            --limit 1 \
            --json databaseId \
            --jq '.[0].databaseId')

          echo "Waiting for release run $RUN_ID to complete ..."
          gh run watch "$RUN_ID" --repo ${{ github.repository }}

          # Check if it succeeded
          STATUS=$(gh run view "$RUN_ID" --repo ${{ github.repository }} --json conclusion --jq '.conclusion')
          if [ "$STATUS" != "success" ]; then
            echo "Release workflow failed with status: $STATUS"
            exit 1
          fi

          echo "Release workflow completed successfully"

      - name: Get released version
        id: version
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          # Get the latest semver tag
          VERSION=$(gh api repos/${{ github.repository }}/tags --jq '[.[] | select(.name | test("^[0-9]+\\.[0-9]+\\.[0-9]+$"))][0].name')

          if [ -z "$VERSION" ] || [ "$VERSION" = "null" ]; then
            echo "Error: Could not determine released version"
            exit 1
          fi

          echo "Released version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Trigger deploy workflow
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          VERSION: ${{ steps.version.outputs.version }}
          ENVIRONMENT: ${{ inputs.environment }}
          RUN_LEGACY_CLUSTER_TESTS: ${{ inputs.run_cluster_tests }}
        run: |
          gh workflow run deploy.yml \
            --repo ${{ github.repository }} \
            -f version_type=specific \
            -f specific_version="$VERSION" \
            -f environment="$ENVIRONMENT" \
            -f run_legacy_cluster_tests="$RUN_LEGACY_CLUSTER_TESTS"

          echo "### Release and Deploy Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: $ENVIRONMENT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Workflows triggered:" >> $GITHUB_STEP_SUMMARY
          echo "- [Release](https://github.com/${{ github.repository }}/actions/workflows/release.yml)" >> $GITHUB_STEP_SUMMARY
          echo "- [Deploy](https://github.com/${{ github.repository }}/actions/workflows/deploy.yml)" >> $GITHUB_STEP_SUMMARY
