name: "Release and Deploy"

run-name: "Release and deploy `${{ inputs.bump_type }}` to `${{ inputs.environment }}`"

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: "Version bump type"
        required: true
        type: choice
        default: patch
        options:
          - patch
          - minor
          - major
      environment:
        description: "Environment to deploy to"
        required: true
        type: choice
        default: prod
        options:
          - dev
          - prod
      run_cluster_tests:
        description: "Run cluster tests for frontend-legacy before deploying"
        required: true
        type: boolean
        default: true

jobs:
  release:
    name: Release
    uses: ./.github/workflows/release.yml
    secrets: inherit
    with:
      bump_type: ${{ inputs.bump_type }}

  deploy:
    name: Trigger Deploy
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Trigger deploy workflow
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          VERSION: ${{ needs.release.outputs.version }}
          ENVIRONMENT: ${{ inputs.environment }}
          RUN_CLUSTER_TESTS: ${{ inputs.run_cluster_tests }}
        run: |
          gh workflow run deploy.yml \
            --repo ${{ github.repository }} \
            -f version_type=specific \
            -f specific_version="$VERSION" \
            -f environment="$ENVIRONMENT" \
            -f run_cluster_tests="$RUN_CLUSTER_TESTS"

          echo "### Deploy Triggered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: $ENVIRONMENT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "A separate deploy workflow has been triggered. Check the [Actions tab](https://github.com/${{ github.repository }}/actions/workflows/deploy.yml) for progress." >> $GITHUB_STEP_SUMMARY
