name: "Release"

run-name: "Release `${{ inputs.bump_type }}`"

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Version bump type'
        required: true
        type: choice
        default: patch
        options:
          - patch
          - minor
          - major
  workflow_call:
    inputs:
      bump_type:
        description: "Version bump type"
        required: false
        type: string
        default: patch
    outputs:
      version:
        description: "Released version"
        value: ${{ jobs.bump-version.outputs.version }}

permissions:
  contents: write

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest

    env:
      FORCE_COLOR: 1
      PYTHONUNBUFFERED: 1
      PYTHONDONTWRITEBYTECODE: 1

    steps:
      - uses: actions/checkout@v5

      - name: Set up Python "3.12"
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Test
        run: make test

  integration-test:
    name: Integration Test
    uses: ./.github/workflows/integration.yml
    with:
      suite: full
    secrets: inherit

  bump-version:
    name: Bump Version
    needs: [test, integration-test]
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      commit_sha: ${{ steps.get_commit.outputs.commit_sha }}

    steps:
      - uses: actions/checkout@v5
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

      - name: Set up Python "3.12"
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Bump version
        run: |
          CURRENT_VERSION=$(grep "^__version__ = " conf/configs/common.py | sed 's/__version__ = "\(.*\)"/\1/')
          echo "Current version: $CURRENT_VERSION"

          IFS='.' read -r -a VERSION_PARTS <<< "$CURRENT_VERSION"
          MAJOR="${VERSION_PARTS[0]}"
          MINOR="${VERSION_PARTS[1]}"
          PATCH="${VERSION_PARTS[2]}"

          case "${{ inputs.bump_type }}" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          echo "New version: $NEW_VERSION"

          sed -i "s/__version__ = \".*\"/__version__ = \"${NEW_VERSION}\"/" conf/configs/common.py

      - name: Commit version bump
        run: |
          git config --global user.name "GitHub Release Bot"
          git config --global user.email "support@heliumedu.com"

          git add conf/configs/common.py

          NEW_VERSION=$(grep "^__version__ = " conf/configs/common.py | sed 's/__version__ = "\(.*\)"/\1/')
          git commit -m "Bump version to ${NEW_VERSION}"

          git push

      - name: Get version and commit SHA
        id: get_version
        run: |
          VERSION=$(grep "^__version__ = " conf/configs/common.py | sed 's/__version__ = "\(.*\)"/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Get commit SHA
        id: get_commit
        run: |
          COMMIT_SHA=$(git rev-parse HEAD)
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "Commit SHA: $COMMIT_SHA"

  build-and-publish:
    name: Build and Publish Containers
    needs: [test, integration-test, bump-version]
    runs-on: ubuntu-latest

    env:
      FORCE_COLOR: 1
      PYTHONUNBUFFERED: 1
      PYTHONDONTWRITEBYTECODE: 1
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      PLATFORM: amd64
      TAG_VERSION: ${{ needs.bump-version.outputs.version }}
      ENVIRONMENT: prod

    steps:
      - uses: actions/checkout@v5
        with:
          ref: ${{ needs.bump-version.outputs.commit_sha }}

      - name: Set up Python "3.12"
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to AWS ECR Public
        run: |
          aws ecr-public get-login-password --region us-east-1 | docker login --username AWS --password-stdin public.ecr.aws/heliumedu

      - name: Build and publish containers
        run: make publish

      - name: Dump Docker logs on failure
        if: failure()
        uses: jwalton/gh-docker-logs@v2

  create-release-tag:
    name: Create Release Tag
    needs: [test, integration-test, bump-version, build-and-publish]
    if: always() && needs.test.result == 'success' && needs.integration-test.result == 'success' && (needs.build-and-publish.result == 'success' || needs.build-and-publish.result == 'skipped')
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          fetch-depth: 0

      - name: Display release info
        run: |
          echo "### Release ${{ needs.bump-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY

      - name: Create and push tag
        env:
          VERSION: ${{ needs.bump-version.outputs.version }}
          COMMIT_SHA: ${{ needs.bump-version.outputs.commit_sha }}
        run: |
          git config --global user.name "GitHub Release Bot"
          git config --global user.email "support@heliumedu.com"

          # Fetch latest changes to ensure we have the version bump commit
          git fetch origin main

          # Create version tag on the specific commit
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "Tag $VERSION already exists, skipping"
          else
            echo "Creating tag $VERSION on commit $COMMIT_SHA"
            git tag -a "$VERSION" -m "Release $VERSION" "$COMMIT_SHA"
            git push origin "$VERSION"
          fi
