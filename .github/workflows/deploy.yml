name: "Deploy"

run-name: "Deploy ${{ inputs.version_type == 'latest' && 'latest' || inputs.specific_version }} to ${{ inputs.environment }}"

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version to deploy'
        required: true
        type: choice
        default: latest
        options:
          - latest
          - specific
      specific_version:
        description: 'Specific version tag (only used if version_type is "specific", ex: 1.2.3)'
        required: false
        type: string
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        default: prod
        options:
          - dev
          - prod
      run_cluster_tests:
        description: 'Run cluster tests before deploying'
        required: true
        type: boolean
        default: true
  workflow_call:
    inputs:
      version_type:
        description: "Version to deploy"
        required: false
        type: string
        default: latest
      specific_version:
        description: "Specific version tag (used when version_type is specific)"
        required: false
        type: string
      environment:
        description: "Environment to deploy to"
        required: false
        type: string
        default: prod
      run_cluster_tests:
        description: "Run cluster tests before deploying"
        required: false
        type: boolean
        default: true

permissions:
  contents: read

concurrency:
  group: "helium-platform-deploy-${{inputs.environment}}"

jobs:
  determine-version:
    name: Determine Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      version_number: ${{ steps.version.outputs.version_number }}

    steps:
      - name: Determine version to deploy
        id: version
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          if [ "${{ inputs.version_type }}" = "latest" ]; then
            VERSION=$(gh api repos/HeliumEdu/platform/tags --jq '[.[] | select(.name | test("^[0-9]+\\.[0-9]+\\.[0-9]+$"))][0].name')

            if [ -z "$VERSION" ] || [ "$VERSION" = "null" ]; then
              echo "Error: No version tags found in HeliumEdu/platform"
              exit 1
            fi

            echo "Using latest version: ${VERSION}"
          else
            VERSION="${{ inputs.specific_version }}"

            if [ -z "$VERSION" ]; then
              echo "Error: specific_version is required when version_type is 'specific'"
              exit 1
            fi

            echo "Using specific version: ${VERSION}"
          fi

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "version_number=${VERSION}" >> $GITHUB_OUTPUT

  test-release:
    name: Test Release
    needs: [determine-version]
    if: ${{ inputs.run_cluster_tests }}
    runs-on: ubuntu-latest

    env:
      FORCE_COLOR: 1
      PYTHONUNBUFFERED: 1
      PYTHONDONTWRITEBYTECODE: 1
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      PLATFORM_EMAIL_HOST_USER: ${{ secrets.PLATFORM_EMAIL_HOST_USER }}
      PLATFORM_EMAIL_HOST_PASSWORD: ${{ secrets.PLATFORM_EMAIL_HOST_PASSWORD }}
      PLATFORM_TWILIO_ACCOUNT_SID: ${{ secrets.PLATFORM_TWILIO_ACCOUNT_SID }}
      PLATFORM_TWILIO_AUTH_TOKEN: ${{ secrets.PLATFORM_TWILIO_AUTH_TOKEN }}
      PLATFORM_TWILIO_SMS_FROM: ${{ vars.PLATFORM_TWILIO_SMS_FROM }}
      CI_AWS_S3_ACCESS_KEY_ID: ${{ secrets.CI_AWS_S3_ACCESS_KEY_ID }}
      CI_AWS_S3_SECRET_ACCESS_KEY: ${{ secrets.CI_AWS_S3_SECRET_ACCESS_KEY }}
      CI_TWILIO_RECIPIENT_PHONE_NUMBER: ${{ secrets.CI_TWILIO_RECIPIENT_PHONE_NUMBER }}

    steps:
      - name: Checkout infra monorepo
        uses: actions/checkout@v5
        with:
          repository: HeliumEdu/infra
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          path: deploy

      - name: Set up Python "3.12"
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install GitHub SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_KEY_GITHUB }}
          known_hosts: ${{ secrets.KNOWN_HOSTS_GITHUB }}
          if_key_exists: replace

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Checkout platform repository
        uses: actions/checkout@v5
        with:
          repository: HeliumEdu/platform
          ref: ${{ needs.determine-version.outputs.version }}
          path: platform-repo

      - name: Set container environment variables
        env:
          VERSION_NUMBER: ${{ needs.determine-version.outputs.version_number }}
        run: |
          echo "PLATFORM_RESOURCE_IMAGE=public.ecr.aws/heliumedu/helium/platform-resource:amd64-${VERSION_NUMBER}" >> $GITHUB_ENV
          echo "PLATFORM_API_IMAGE=public.ecr.aws/heliumedu/helium/platform-api:amd64-${VERSION_NUMBER}" >> $GITHUB_ENV
          echo "PLATFORM_WORKER_IMAGE=public.ecr.aws/heliumedu/helium/platform-worker:amd64-${VERSION_NUMBER}" >> $GITHUB_ENV

          cd platform-repo
          FRONTEND_LEGACY_VERSION=$(grep '^FRONTEND_LEGACY_VERSION = ' conf/configs/common.py | sed 's/FRONTEND_LEGACY_VERSION = "\(.*\)"/\1/')
          echo "FRONTEND_IMAGE=public.ecr.aws/heliumedu/helium/frontend:amd64-${FRONTEND_LEGACY_VERSION}" >> $GITHUB_ENV
          cd ..

      - name: Install dependencies
        working-directory: deploy
        run: make install

      - name: Run cluster tests against release build
        working-directory: deploy
        env:
          TAG_VERSION: ${{ needs.determine-version.outputs.version }}
        run: make test-cluster

      - name: Upload test output
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: cluster-test-output-${{ needs.determine-version.outputs.version }}
          path: deploy/projects/cluster-tests/build/screenshots/
          retention-days: 30

      - name: Dump Docker logs on failure
        if: failure()
        uses: jwalton/gh-docker-logs@v2

  deploy:
    name: Deploy to ${{ inputs.environment }}
    needs: [determine-version, test-release]
    if: always() && needs.determine-version.result == 'success' && (needs.test-release.result == 'success' || needs.test-release.result == 'skipped')
    runs-on: ubuntu-latest

    env:
      FORCE_COLOR: 1
      PYTHONUNBUFFERED: 1
      PYTHONDONTWRITEBYTECODE: 1
      TERRAFORM_API_TOKEN: ${{ secrets.TERRAFORM_API_TOKEN }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      ENVIRONMENT: ${{ inputs.environment }}
      VERSION_NUMBER: ${{ needs.determine-version.outputs.version_number }}

    steps:
      - name: Checkout platform repository
        uses: actions/checkout@v5

      - name: Checkout infra repository
        uses: actions/checkout@v5
        with:
          repository: HeliumEdu/infra
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          path: deploy
          fetch-depth: 0

      - name: Set up Python "3.12"
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Setup git
        run: |
          git config --global user.name "GitHub Release Bot"
          git config --global user.email "support@heliumedu.com"
          cd deploy
          git config user.name "GitHub Release Bot"
          git config user.email "support@heliumedu.com"

      - name: Install dependencies
        run: pip install requests GitPython boto3

      - name: Run deployment script
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          ./bin/deploy-release.py \
            "$VERSION_NUMBER" \
            "$ENVIRONMENT" \
            --deploy-repo ./deploy

      - name: Notify Sentry of deploy
        uses: getsentry/action-release@v1
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: helium-edu
          SENTRY_PROJECT: "4510851407413248"
        with:
          environment: ${{ inputs.environment }}
          version: ${{ needs.determine-version.outputs.version }}

      - name: Deployment summary
        env:
          VERSION: ${{ needs.determine-version.outputs.version }}
          ENVIRONMENT: ${{ inputs.environment }}
        run: |
          if [ "$ENVIRONMENT" = "prod" ]; then
            URL="https://api.heliumedu.com"
          else
            URL="https://api.${ENVIRONMENT}.heliumedu.com"
          fi

          echo "### Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${ENVIRONMENT}" >> $GITHUB_STEP_SUMMARY
          echo "- **API URL**: ${URL}" >> $GITHUB_STEP_SUMMARY
